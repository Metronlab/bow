# Golang CircleCI 2.0 configuration file
#
version: 2
jobs:
	build:
	docker:
		- image: circleci/golang:1.9

	working_directory: /go/src/bow
	steps:
		- checkout
		- run:
			- name: Get go linters
			- command: |
				go get golang.org/x/lint/golint honnef.co/go/tools/cmd/staticcheck github.com/client9/misspell/cmd/misspell golang.org/x/tools/go/analysis/passes/shadow/cmd/shadow github.com/jstemmer/go-junit-report
		- run:
			- name: Check code
			- command: |
				gofiles=$(find . -name '*.go' | grep -v -e '^./vendor' | grep -v -e '^./.tmp')
				echo run on ${gofiles}
				echo RUN GOLINT
				test -z "$(golint ./... | grep -v -e "should have comment" -e "vendor/" -e "mocks/" -e ".tmp/" | tee /dev/stderr )"
				echo RUN STATICCHECK
				staticcheck ./...
				echo RUN MISSPELL
				echo ${gofiles} | xargs misspell -error
				echo RUN GOVET
				go vet ./...
				echo RUN GOFMT
				unformatted=$(gofmt -s -l ${gofiles})
				[ -z "${unformatted}" ] && exit 0
				echo >&2 "Some files are not formatted, please run docker-compose run --rm fmt or edit the files"
				echo >&2 "Unformatted files:"
				echo >&2 ${unformatted}
